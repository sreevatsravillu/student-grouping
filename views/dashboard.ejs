<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="./../public/style.css">
  
  <style>
    /* Add styles for clipped drawer */
    body {
      display: flex;
      min-height: 100vh;
      flex-direction: column;
      font-family: FF Real Head, Lato, Arial, sans-serif !important;
    }

    main {
      flex: 1 0 auto;
      padding-left: 60px; /* Width of the side nav */
    }
    default-bg-color{
      background-color: #c8102e !important
    }
    /* Fixed navbar */
    nav {
      background-color: black !important;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 997;
    }
    .header-logo{
      height: 100%;
      width: 6%;
    }
    .brand-logo{
      font-size: 1.5rem !important;
      font-weight: bold;
    }
    /* Fixed sidenav */
    .sidenav {
      width:160px !important; 
      height: calc(100% - 64px); /* Subtract navbar height */
      top: 64px; /* Start below navbar */
      box-shadow: none;
      border-right: 1px solid #ddd;
      a{
        padding:0 18px !important;
      }
    }


    .side-nav-button {
      width: 100%;
      text-align: left;
      padding: 0 32px;
    }
    .sidenav li>a>i.material-icons {
    margin: 0px 12px 0 0;
    }

    .clear-data-btn {
      color: #f44336;
      display: flex;
      float: right;
      border: 0.4px solid #f44336;
      border-radius: 6px;
    }
 
    #url-text{
      border-radius: 4px;
      padding: 10px;
      border: 0.2px solid gray;
    }
    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      height: 32px;
      padding: 0 12px;
      margin: 0;
      font-size: 13px;
      border-radius: 16px;
    }

    .chip i {
      margin-right: 4px;
    }

    .group-name {
      font-weight: 500;
      color: rgba(0, 0, 0, 0.87);
    }

    .highlight tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.04);
    }
    .card .table-container {
    margin: 0;
    padding: 0;
    overflow-x: auto;
    }
    #formNameLabel{
      font-weight: bold;
      font-size: 18px;
    }

  table.bordered {
    border: 1px solid rgba(177 174 174);
    border-collapse: collapse;
  }

  table.bordered th,
  table.bordered td {
    border: 1px solid rgba(177 174 174);
  }
  thead {
    background-color: #dd3350 !important; /* Material Blue 800 */
  }

  th {
    min-width: 110px;
    background-color: #f5f5f5;
    padding: 16px !important;
    border-bottom: 1px solid rgba(177 174 174);
    font-weight: 600 !important;
  }
  td {
    padding: 16px !important;
    border-bottom: 1px solid rgba(177 174 174);
  }

  /* Vertical grid lines */
  td:not(:last-child),
  th:not(:last-child) {
    border-right: 1px solid rgba(177 174 174);
  }

  /* Horizontal grid lines */
  tr:not(:last-child) td {
    border-bottom: 1px solid rgba(177 174 174);
  }


    /* Responsive adjustments */
    @media only screen and (max-width: 992px) {
      main {
        padding-left: 0;
      }
      
      .sidenav {
        height: 100%;
        top: 0;
      }
    }

    /* Add padding to main content to prevent overlap with navbar */
    .main-content {
      margin-top: 84px;
      margin-left: 140px;
      width: 86%;
    }
  </style>
</head>
<body>
  <!-- Fixed Navbar -->
  <nav class="default-bg-color">
    <div class="nav-wrapper">
      <a href="#" data-target="slide-out" class="sidenav-trigger hide-on-large-only">
        <i class="material-icons">menu</i>
      </a>
      <img src="/Northeastern_Huskies.svg" alt="logo" class="header-logo" >
      <a href="#" class="brand-logo">Student Groups Dashboard</a>
    </div>
  </nav>

  <!-- Clipped Side Navigation -->
  <ul id="slide-out" class="sidenav sidenav-fixed">
    <li><a href="/form-builder" class="waves-effect"><i class="material-icons">build</i>Form Builder</a></li>
    <li><div class="divider"></div></li>
  </ul>

  <!-- Main Content -->
  <main>
    <div class="container main-content">
        <div class="drawer-header">
          <button class="clear-data-btn btn-flat waves-effect btn-outlined" onclick="confirmClear()">
            <i class="material-icons">delete</i>
            Clear Data
          </button>
        </div>
  
<div id="student-form-url" style="margin-bottom: 20px;">
  <ul>
    <% formKeys.forEach(key => { %>
      <li style="padding-bottom: 10px;">
        <span id="formNameLabel"><%= `${key}` %> : </span>
        <span id="url-text"><%= `${baseUrl}/${key}` %></span> <!-- Construct the URL directly in EJS -->
        <button class="btn copy-url-btn waves-effect waves-light" style="margin-left: 10px; background-color: #c8102e; color: white;">Copy URL</button> <!-- Updated Copy button style -->
        <button class="btn show-groups-btn waves-effect waves-light" 
        style="margin-left: 10px; background-color: #c8102e; color: white;"
        data-key="<%= key %>">Show groups</button> 
      </li>
    <% }) %>
  </ul>
</div>

<div>
  <h5>Student Groups : <span style="color:#c8102e"><%= `${selectedForm}` %></span></h5>
</div>
      <div class="row">
        <div class="col s12">
          <div class="card">
            <div class="card-content">
              <div class="table-container">
                <table class="highlight bordered responsive-table">
                  <thead>
                    <tr>
                      <th style="font-weight: 600; color: rgba(0, 0, 0, 0.87); background-color: #cfd8dc;">Group</th>
                      <th style="font-weight: 600; color: rgba(0, 0, 0, 0.87); background-color: #cfd8dc;">Students</th>
                      <th style="font-weight: 600; color: rgba(0, 0, 0, 0.87); background-color: #cfd8dc;">Skills</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% for (const group in groups) { %>
                      <tr>
                        <td class="group-cell">
                          <div class="group-name"><%= group %></div>
                        </td>
                        <td>
                          <div class="chip-container">
                            <% groups[group].students.forEach(student => { %>
                              <div class="chip">
                                <i class="material-icons tiny">person</i>
                                <%= student %>
                              </div>
                              <% }) %>
                          </div>
                  </td>
                  <td>
                    <div class="chip-container">
                      <% Array.from(groups[group].skills).forEach(skill => { %>
                        <div class="chip blue-grey lighten-4">
                          <i class="material-icons tiny">code</i>
                          <%= skill %>
                        </div>
                      <% }) %>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var elems = document.querySelectorAll('.sidenav');
      var instances = M.Sidenav.init(elems, {
        edge: 'left',
        draggable: true
      });
    });

    async function confirmClear() {
      if (confirm('Are you sure you want to clear all student data and start a new batch?')) {
        try {
          const response = await fetch('/clear-all', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            window.location.reload();
          } else {
            M.toast({html: 'Failed to clear data'});
          }
        } catch (error) {
          console.error('Error:', error);
          M.toast({html: 'Failed to clear data'});
        }
      }
    }

  
    document.querySelectorAll('.copy-url-btn').forEach((button, index) => {
      button.addEventListener('click', function() {
        const key = JSON.parse('<%- JSON.stringify(formKeys) %>')[index]; // Get the corresponding key
        const studentFormUrl = '<%- baseUrl %>' + '/' + key; // Use the base URL from the server

        console.log('Copying URL:', studentFormUrl); // Debugging line

        navigator.clipboard.writeText(studentFormUrl).then(() => {
          M.toast({html: 'URL copied to clipboard!'}); // Show success message
        }).catch(err => {
          console.error('Error copying URL: ', err);
          M.toast({html: 'Failed to copy URL'}); // Show error message
        });
      });
    });
 
document.querySelectorAll('.show-groups-btn').forEach(button => {
  button.addEventListener('click', function() {
    const reqKey = this.getAttribute('data-key'); // Get the key from the button's data attribute 
    try {
      const response =   fetch('/fetchFormGrouing', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ key: reqKey }) // Send the key in the request body
    });
      
        window.location.reload(); // Refresh the page after successful clear
  
    }catch(error) {
      console.error('There was a problem with the fetch operation:', error);
    };
  });
});

  </script>
</body>
</html>
